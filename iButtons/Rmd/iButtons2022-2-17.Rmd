---
title: "iButton Temperature Data from 40 Aquatic Plots"
author: "Jana Peirce, Emily Watson-Cook"
date: "July 19 - Aug 23, 2021"
output: html_document
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(fig.width = 8, fig.height = 5, echo = FALSE, warning = FALSE, message = FALSE)
```

```{r message = FALSE}
library(dplyr)
library(tidyr)
library(readr)
library(ggplot2)
library(scales)
library(here)
library(stringr)
```
Thermocron iButton data loggers were installed on July 19, 2021, in 30 thaw ponds in the NIRPO and Jorgenson Field Sites, Prudhoe Bay, Alaska, and programmed to record temperature in degrees Celsius every hour. They were retrieved on August 23, 2021.

Sensors were installed in the following locations in each pond:

* Water surface
* Above the moss layer
* At the sediment surface. 

Two additional sensors were installed to record air temperature at each site (NIRPO and Jorgenson), and one sensor was installed at the water surface in a lake at the Jorgenson site.


```{r}
#read in ibutton temp data

ibtn_temp <- read.csv("../data/ibtn_temp_tbl.csv")
```


```{r}
# transform data table from wide to long format

temp_long <- ibtn_temp %>% 
  pivot_longer(cols = c(-Date, -Time), names_to = "iBtn_ID", values_to = "temp_c") 
```

```{r}
# convert date col from char to date format
date_temp_long <- data.frame(temp_long)
date_temp_long$Date <- as.Date(date_temp_long$Date)
```


```{r}
#read in plot type table

plot_type <- read.csv("../data/plot_type_tbl.csv")
```

```{r}
# join both tables together

iBtn_summaryX <- left_join(date_temp_long, plot_type, by = c("iBtn_ID")) 
```

### Raw Data (99,720 rows)

```{r}
# remove leading X from iBtn_ID

iBtn_summary <- iBtn_summaryX %>% 
  mutate_at("iBtn_ID", str_replace, "X", "")

knitr::kable(head(iBtn_summary[, 1:7]), "simple", col.names = c("Date","Time","iBtn ID","Temp (\u00B0C)","Plot ID","Sensor Type","Plot Type"))
```

### Average Daily Temperature (4320 rows)

```{r}
# calculate average daily temp

avg_daily_temp <- iBtn_summary %>%
  group_by(Date, iBtn_ID, Plot_ID, Sensor_type, Plot_type) %>% 
  summarize(avg_daily_temp = mean(temp_c, na.rm = T), .groups = "drop")

knitr::kable(head(avg_daily_temp[, 1:6]), "simple", col.names = c("Date","iBtn ID","Plot ID","Sensor Type","Plot Type","Avg Daily Temp (\u00B0C)"))
```

```{r}
#plot adt all ibuttons

p <- ggplot(avg_daily_temp, aes(x = Date, y = avg_daily_temp)) +
  geom_point(alpha = 0.3, color = "dodgerblue2") +
  labs(title = "Average Daily Temperature", x = NULL, y = "Temperature (\u00B0C)") +
  theme(plot.title = element_text(hjust = 0.5))

p

p.adt_all_ibtn <- p
```

```{r}
ggsave(here("iButtons/figures/", "adt-all-ibtn8x5.png"), plot = p.adt_all_ibtn)
```

```{r}
# plot by sensor location

p <- ggplot(avg_daily_temp, aes(x = Date, y = avg_daily_temp, color=Sensor_type)) +
  geom_point(alpha = 0.3) +
  labs(title = "Average Daily Temperature by Sensor Location", x = NULL, y = "Temperature (\u00B0C)", color = "Sensor Type")  +
  theme(plot.title = element_text(hjust = 0.5))

p

p.adt_sensor_loc <-  p
```

```{r}
ggsave(here("iButtons/figures/", "adt-sensor-loc8x5.png"), plot = p)
```

```{r}
# subset to remove sensors not assoc with plots

adt_plot_clean <- subset(avg_daily_temp, Plot_type!="N/A" & Plot_type!="Lake")
```

```{r}
# plot by plot type

p <- ggplot(adt_plot_clean, aes(x = Date, y = avg_daily_temp, color=Plot_type)) +
  geom_point(alpha = 0.3) +
  labs(title = "Average Daily Temperature by Aquatic Plot Type", x = NULL, y = "Temperature (\u00B0C)", color = "Plot Type")  +
  theme(plot.title = element_text(hjust = 0.5))

p

p.adt_plot_type <- p
```

```{r}
ggsave(here("iButtons/figures/", "adt-plot-type8x5.png"), plot = p.adt_plot_type)
```
```{r}
# calculate avg daily temp for each day by sensor type

adt_sensor_type <- iBtn_summary %>% 
  group_by(Date, Sensor_type) %>% 
  summarize(avg_daily_temp = mean(temp_c, na.rm = T), .groups = "drop")
```

```{r}
# calculate mean for all days by sensor location

mean_sensor_type <- iBtn_summary %>% 
  group_by(Sensor_type) %>% 
  summarize(avg_daily_temp = mean(temp_c, na.rm = T), .groups = "drop") %>% mutate(across(where(is.numeric), ~ round(., 1)))
```

```{r}
# plot mean sensor type for season

p <- ggplot(mean_sensor_type, aes(Sensor_type, avg_daily_temp)) +
  geom_col(fill="salmon") +
  labs(title = "Mean Temperature by Sensor Location", x = "Sensor Location", y = "Mean Temp (\u00B0C)") + theme(panel.background = element_blank(), plot.title = element_text(hjust = 0.5)) +
  geom_text(aes(label = avg_daily_temp), vjust = -0.5)

p

knitr::kable(head(mean_sensor_type[, 1:2]), "simple", col.names = c("Sensor Type", "Mean Temp (\u00B0C)"))

p.mean_sensor <- p
```

```{r}
# print plot

ggsave(here("ibuttons/figures/", "mean-sensor-loc.png"), plot = p.mean_sensor)
```

```{r}
# subset to remove sensors not assoc with plots
# then calculate average daily temp for each day by plot type

iBtn_summary_plot <- subset(iBtn_summary, Plot_type!="N/A" & Plot_type!="Lake")

adt_plot_type <- iBtn_summary_plot %>% 
  group_by(Date, Plot_type) %>% 
  summarize(avg_daily_temp = mean(temp_c, na.rm = T), .groups = "drop")
```

```{r}
# calculate mean for all days by plot type

mean_plot_type <- iBtn_summary_plot %>% 
  group_by(Plot_type) %>% 
  summarize(avg_daily_temp = mean(temp_c, na.rm = T), .groups = "drop") %>% mutate(across(where(is.numeric), ~ round(., 1)))
```

```{r}
# plot mean plot type for season

p <- ggplot(mean_plot_type, aes(Plot_type, avg_daily_temp)) +
  geom_col(fill="darkolivegreen3") +
  labs(title = "Mean Temperature by Aquatic Plot Type", x = "Plot Type", y = "Mean Temp (\u00B0C)") + theme(panel.background = element_blank(), plot.title = element_text(hjust = 0.5)) +
  geom_text(aes(label = avg_daily_temp), vjust = -0.5)

p

knitr::kable(head(mean_plot_type[, 1:2]), "simple", col.names = c("Plot Type", "Mean Temp (\u00B0C)"))

p.mean_plot <- p
```

```{r}
# print plot

ggsave(here("ibuttons/figures/", "mean-plot.png"), plot = p.mean_plot)
```

```{r}
# Facet plot by sensor type

p <- ggplot(avg_daily_temp, aes(x = Date, y = avg_daily_temp)) +
  geom_point(alpha=0.2, color = "firebrick") +
  facet_wrap(~Sensor_type, ncol=2) +
  labs(title = "Average Daily Temperature by Sensor Location", x = NULL, y = "Temp (\u00B0C)")  +
  theme(plot.title = element_text(hjust = 0.5))

p

p.adt_sensor_facet <- p
```

```{r}
ggsave(here("iButtons/figures/", "adt-sensor-facet.png"), plot = p.adt_sensor_facet)
```


```{r}
# Facet plots by plot type

p <- ggplot(adt_plot_clean, aes(x = Date, y = avg_daily_temp)) +
  geom_point(alpha=0.2, color = "darkolivegreen4") +
  facet_wrap(~Plot_type, ncol=2) +
  labs(title = "Average Daily Temperature by Plot Type", x = NULL, y = "Temp (\u00B0C)") +
  theme(plot.title = element_text(hjust = 0.5))

p

p.adt_plot_facet <- p
```

```{r}
ggsave(here("iButtons/figures/", "adt-plot-facet.png"), plot = p.adt_plot_facet)
```

```{r}
# filter out some plots for smaller facet set

sedi_moss_filter <- avg_daily_temp %>% 
    filter(Sensor_type == "Sediment", Plot_type == "Thick moss")

sedi_moss_filter

```

```{r}
# Facet plots by select plots

p <- ggplot(sedi_moss_filter, aes(x = Date, y = avg_daily_temp)) +
  geom_point(alpha = 0.3, color = "purple") +
  facet_wrap(~Plot_ID, ncol = 4) + 
  labs(title = "Avg. Daily Temp at Sediment Layer in Thick Moss Plots", x = NULL, y = "Temperature (\u00B0C)") +
  theme(plot.title = element_text(hjust = 0.5), axis.text.x = element_text(angle=45, hjust = 1))

p

p.sedi_moss_facet <- p
```

```{r}
ggsave(here("ibuttons/figures/","sedi-moss-facet.png"), plot = p.sedi_moss_facet, width = 8, height = 5, units = "in")
```

